<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>用户订单</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
        <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
        <link href="/css/weui.min.css" rel="stylesheet" />
        <link href="/css/jquery-weui.min.css" rel="stylesheet" />
        <link href="/css/app.css" media="screen" rel="stylesheet"/>
    </head>
    <body>
        <div id="orderList">
            <div class="weui-form-preview" v-for="(order, index) in orders">
                <div class="weui-form-preview__hd">
                    <div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">订单编号:</label>
                        <span class="dsx-user-info">{{order.id}}</span>
                    </div>
                </div>
                <div class="weui-form-preview__bd">
                    <div class="weui-form-preview__item" v-for="(item, itemNo) in order.items">
                        <div class="weui-media-box weui-media-box_appmsg">
                            <div class="weui-media-box__hd">
                                <img class="dsx-order-thumb" v-bind:src="item.imageUrl" width="60" height="60">
                                </img>
                            </div>
                            <div class="weui-media-box__bd">
                                <h4 class="weui-media-box__title">{{item.productName}}</h4>
                                <span class="weui-form-preview__value">
                                    {{item.productDescription}}
                                </span>
                                <p class="weui-media-box__desc">
                                    <span>
                                        {{item.productPrice}} + ' x ' + {{item.quantity}}
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="weui-media-box__bd">
                        <div class="dsx-order-money">
                        <span>
                            {{'共' + order.itemCount + '件商品, 共计￥ '+ order.totalAmount }}
                        </span>
                        </div>
                    </div>
                    <div class="weui-media-box__bd">
                    <span>
                        {{ '订单状态：' + order.statusText }}
                    </span>
                    </div>
                    <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_default"
                       v-if="order.status === 'CREATED'" v-on:click="onPay(index, $event)">付款</a>
                    <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_warn"
                       v-if="order.status === 'CREATED'" v-on:click="onCancel(index, $event)">取消</a>
                    <!--
                    <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_warn"
                       v-if="order.status === 'PAID'" v-on:click="onRefund(index, $event)">申请退款</a>
                    -->
                </div>
            </div>
        </div>
        
        <div id="code" style="display:none" th:text="${{code}}"></div>

        <script src="/js/jquery.min.js"></script>
        <script src="/js/jquery-weui.min.js"></script>
        <script src="/js/jquery-3.2.1.min.js"></script>
        <script src="/js/bootstrap.min.js"></script>
        <script src="/js/vue.js"></script>
        <script type="text/javascript">
            var wxPayMpOrderResult = undefined;

            var app = new Vue({
                el: '#orderList',
                data: {
                    orders: [
                    ],
                },
                created: function() {
                    $.ajax({
                        url: '/api/v1/Order',
                        contentType: 'application/json',
                        accept: 'application/json',
                        type: 'GET',
                    }).done(function (response) {
                        response.forEach(function(order) {
                            app.orders.push(order);
                        });
                    });
                },
                methods: {
                    onPay : function(index, event) {
                        var order = app.orders[index];
                        $.ajax({
                            url: '/api/v1/Order/' + order.id + '/initiatePay',
                            contentType: 'application/json',
                            accept: 'application/json',
                            type: 'POST',
                            //data: JSON.stringify(order),
                        }).done(function (response) {
                            wxPayMpOrderResult = response;
                        });
                    },
                    onCancel : function(index, event) {
                        var order = app.orders[index];
                        $.ajax({
                            url: '/api/v1/Order/' + order.id + '/cancelPay',
                            contentType: 'application/json',
                            accept: 'application/json',
                            type: 'POST',
                            //data: JSON.stringify(order),
                        }).done(function (response) {
                            order.status = 'CANCELLED';
                            order.statusText = '已取消';
                            Vue.set(app.orders, index, order);
                        });
                    },
                    onRefund : function(index, event) {

                    },
                }
            });

            function onBridgeReady(){
               WeixinJSBridge.invoke(
                   'getBrandWCPayRequest', {
                       "appId": wxPayMpOrderResult.appId,               //公众号名称，由商户传入
                       "timeStamp": wxPayMpOrderResult.timeStamp,       //时间戳，自1970年以来的秒数
                       "nonceStr": wxPayMpOrderResult.nonceStr,         //随机串
                       "package": wxPayMpOrderResult.package,
                       "signType": wxPayMpOrderResult.signType,         //微信签名方式：
                       "paySign": wxPayMpOrderResult.paySign            //微信签名
                   },
                   function(res) {
                       // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回
                       // ok，但并不保证它绝对可靠。
                       if(res.err_msg == "get_brand_wcpay_request:ok" ) {
                           // TODO: navigate to the order page or success paid info page
                           // TODO: But please make sure the code above works as document first
                       }
                   }
               );
            }

            if (typeof WeixinJSBridge == "undefined"){
               if( document.addEventListener ){
                   document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
               }else if (document.attachEvent){
                   document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
                   document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
               }
            }else{
               onBridgeReady();
            }
        </script>
    </body>
</html>
