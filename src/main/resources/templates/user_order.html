<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>用户订单</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
        <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
        <link href="/css/weui.min.css" rel="stylesheet" />
        <link href="/css/jquery-weui.min.css" rel="stylesheet" />
        <link href="/css/app.css" media="screen" rel="stylesheet"/>
    </head>
    <body>
        <div id="orderList">
            <div class="weui-form-preview" v-for="(order, index) in orders">
                <div class="weui-form-preview__hd">
                    <div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">订单编号:</label>
                        <span class="dsx-user-info">{{order.id}}</span>
                    </div>
                </div>
                <div class="weui-form-preview__bd">
                    <div class="weui-form-preview__item" v-for="(item, itemNo) in order.items">
                        <div class="weui-media-box weui-media-box_appmsg">
                            <div class="weui-media-box__hd">
                                <img class="dsx-order-thumb" v-bind:src="item.imageUrl" width="60" height="60">
                                </img>
                            </div>
                            <div class="weui-media-box__bd">
                                <h4 class="weui-media-box__title">{{item.productName}}</h4>
                                <span class="weui-form-preview__value">
                                    {{item.productDescription}}
                                </span>
                                <p class="weui-media-box__desc">
                                    <span>
                                        {{item.productPrice}} + ' x ' + {{item.quantity}}
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="weui-media-box__bd">
                        <div class="dsx-order-money">
                        <span>
                            {{'共' + order.itemCount + '件商品, 共计￥ '+ order.totalAmount }}
                        </span>
                        </div>
                    </div>
                    <div class="weui-media-box__bd">
                    <span>
                        {{ '订单状态：' + order.statusText }}
                    </span>
                    </div>
                    <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_default"
                       v-if="order.status === 'CREATED'" v-on:click="onPay(index, $event)">付款</a>
                    <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_warn"
                       v-if="order.status === 'CREATED'" v-on:click="onCancel(index, $event)">取消</a>
                    <!--
                    <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_warn"
                       v-if="order.status === 'PAID'" v-on:click="onRefund(index, $event)">申请退款</a>
                    -->
                </div>
            </div>
        </div>
        
        <div id="code" style="display:none" th:text="${{code}}"></div>

        <script src="/js/jquery.min.js"></script>
        <script src="/js/jquery-weui.min.js"></script>
        <script src="/js/jquery-3.2.1.min.js"></script>
        <script src="/js/bootstrap.min.js"></script>
        <script src="/js/vue.js"></script>
        <script src="/js/jweixin-1.2.0.js"></script>
        <script src="/js/wxjssdk.js"></script>
        <script type="text/javascript">
            var app = new Vue({
                el: '#orderList',
                data: {
                    orders: [
                    ],
                },
                created: function() {
                    $.ajax({
                        url: '/api/v1/Order',
                        contentType: 'application/json',
                        accept: 'application/json',
                        type: 'GET',
                    }).done(function (response) {
                        response.forEach(function(order) {
                            app.orders.push(order);
                        });
                    });
                },
                methods: {
                    onPay : function(index, event) {
                        var order = app.orders[index];
                        $.ajax({
                            url: '/api/v1/Order/' + order.id + '/initiatePay',
                            contentType: 'application/json',
                            accept: 'application/json',
                            type: 'POST',
                            //data: JSON.stringify(order),
                        }).done(function (response) {
                            if (response.success) {
                                wx.chooseWXPay({
                                    timestamp: response.timestamp,
                                    nonceStr: response.nonceStr,
                                    package: response.package,
                                    signType: response.signType,
                                    paySign: response.paySign,
                                    success: function(res) {
                                        console.log(res);
									    window.location.href = "/paymentResult/" + order.id;
                                    }
                                });
                            } else {
                                alert(response.message);
								window.location.href = "/paymentResult/" + order.id;
                            }
                        });
                    },
                    onCancel : function(index, event) {
                        var order = app.orders[index];
                        $.ajax({
                            url: '/api/v1/Order/' + order.id + '/cancelPay',
                            contentType: 'application/json',
                            accept: 'application/json',
                            type: 'POST',
                            //data: JSON.stringify(order),
                        }).done(function (response) {
                            order.status = 'CANCELLED';
                            order.statusText = '已取消';
                            Vue.set(app.orders, index, order);
                        });
                    },
                    onRefund : function(index, event) {
                        var order = app.orders[index];
                        $.ajax({
                            url: '/api/v1/Order/' + order.id + '/requestRefund',
                            contentType: 'application/json',
                            accept: 'application/json',
                            type: 'POST',
                        }).done(function (response)) {
                            order.status = 'REFUND_REQUESTED';
                            order.statusText = '退款申请中';
                            Vue.set(app.orders, index, order);
                        };
                    },
                }
            });
        </script>
    </body>
</html>
